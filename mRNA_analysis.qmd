---
title: "mRNA_analysis"
format: html
editor: visual
---

## Set Working directory

```{r setup}
own_path <- "/Users/kseniakirdey/Desktop/DTU/R_for_bio_data_science/lab_10_Project"
knitr::opts_knit$set(root.dir = paste0(own_path, "/group_04_project/data/"))
```

## Load Libraries

```{r}
library(tidyverse)
library(ggrepel)
```

## Fetch dataset

```{r}
mRNA_log_long_full <- readRDS(paste0(own_path, "/group_04_project/data/mRNA_aug.RDS"))
top_genes_stat <- readRDS(paste0(own_path, "/group_04_project/data/mRNA_top_genes_stat.RDS"))
mrna_cle <- readRDS(paste0(own_path, "/group_04_project/data/mRNA_data_clean.RDS"))
```

Subsetting top 25 "log Fold Changed" genes for a better visualisation:

```{r}
top_genes_stat_subset <- top_genes_stat |>
  arrange(desc(abs(logFC))) |>
  head(n = 25)

top_genes <- top_genes_stat_subset$genes
```

Uniting Stages in one group to facet the plots based on them later on.

```{r}
# unique(miRNA_log_long_full$ajcc_pathologic_stage)
mRNA_log_long_full <- mRNA_log_long_full |>
  mutate(Stage = case_when(
    ajcc_pathologic_stage == "Stage I" | ajcc_pathologic_stage == "Stage IA" ~ "Stage I",
    ajcc_pathologic_stage == "Stage II" | ajcc_pathologic_stage == "Stage IIA" |
    ajcc_pathologic_stage == "Stage IIB" ~ "Stage II",
    ajcc_pathologic_stage == "Stage III" | ajcc_pathologic_stage == "Stage IIIA" |
    ajcc_pathologic_stage == "Stage IIIB" | ajcc_pathologic_stage == "Stage IIIC" ~ "Stage III",
    ajcc_pathologic_stage == "Stage IV" | ajcc_pathologic_stage == "Stage IVB" ~ "Stage IV"
  )) |>
  select(-ajcc_pathologic_stage)
```

## First graph

-   From the graph below, it can be seen that, in general, mRNAs expression is higher in cancer tissues.

```{r}
mRNA_log_long_full |>
  filter(genes %in% top_genes) |> 
  filter(!is.na(Stage)) |>
  ggplot(aes(x = genes,
             y = log_reads,
             col = Status)) +
  geom_point() +
  labs(title = "Comparison of expression of 25 top differentially expressed mRNAs \nbetween cancer and normal TCGA samples", color = "Tissue Type",
       x = "mRNA IDs",
       y = "Log2 expression") +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1),
    plot.title = element_text(
      size = 12, 
      angle = 0)) +
  facet_wrap(~ Stage)
```

## Volcano plot

-   In the following volcano plot, statistically significant values are highlighted in blue (the p-value is flipped, so it becomes more significant with the higher values). Positive LFC indicates higher expression in the cancer group compared to the normal tissues, that is in accordance with the plots above.

```{r}
# stating the significance based on the adjusted pvalues (FDR corrects for multiple comparisons)
top_genes_stat <- top_genes_stat |>
    mutate(
      significance = case_when(
        FDR > 0.05 ~ "no",
        FDR <= 0.05 ~ "yes"
      )
    )
```

```{r}
top_genes_stat <- top_genes_stat |>
  mutate(
    regulation = case_when(
      logFC > 1 ~ "Upregulated",
      logFC < -1 ~ "Downregulated",
      TRUE ~ "Non-significant"
    )
  )
```

```{r}
top_genes_stat |> 
  ggplot(aes(x = logFC,
             y = -log10(FDR),
             col = regulation)) +
  geom_point() +
  scale_color_manual(values = c("Upregulated" = "red", 
                                "Downregulated" = "blue", 
                                "Non-significant" = "gray"),
                     name = "Type of genes regulation") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  labs(x = "Log Fold Change",
       y = "-log10(FDR)",
       title = "Top Differentially Expressed mRNAs in TCGA-COAD Samples") +
  theme(plot.title = element_text(hjust = 0.5))
```

## Clean environment

```{r}
rm(mRNA_log_long_full)
rm(top_genes_stat)
rm(top_genes_stat_subset)
rm(top_genes)
```
