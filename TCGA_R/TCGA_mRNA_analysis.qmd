---
title: "mRNA_analysis"
format: html
editor: visual
---

## Set Working directory

```{r setup}
own_path <- "/Users/kseniakirdey"
knitr::opts_knit$set(root.dir = paste0(own_path, "/group_04_project/TCGA_Data/"))
```

## Load Libraries

```{r}
library(tidyverse)
library(ggrepel)
```

## Fetch dataset

```{r}
mRNA_log_long <- readRDS(paste0(own_path, "/group_04_project/TCGA_Data/mRNA_aug.RDS"))
top_genes_stat <- readRDS(paste0(own_path, "/group_04_project/TCGA_Data/mRNA_top_genes_stat.RDS"))
mRNA_metadata <- readRDS(paste0(own_path, "/group_04_project/TCGA_Data/mRNA_metadata_clean.RDS"))
```

Subseting top 25 "log Fold Changed" genes for a better visualisation:

```{r}
top_genes_stat_subset <- top_genes_stat |>
  arrange(desc(abs(logFC))) |>
  head(n = 25)

top_genes <- top_genes_stat_subset$genes
```

## Stages comparison

Uniting Stages in one group to facet the plots based on them later on.

```{r}
mRNA_metadata <- mRNA_metadata |>
  mutate(Stage = case_when(
    ajcc_pathologic_stage == "Stage I" | ajcc_pathologic_stage == "Stage IA" ~ "Stage I",
    ajcc_pathologic_stage == "Stage II" | ajcc_pathologic_stage == "Stage IIA" |
    ajcc_pathologic_stage == "Stage IIB" ~ "Stage II",
    ajcc_pathologic_stage == "Stage III" | ajcc_pathologic_stage == "Stage IIIA" |
    ajcc_pathologic_stage == "Stage IIIB" | ajcc_pathologic_stage == "Stage IIIC" ~ "Stage III",
    ajcc_pathologic_stage == "Stage IV" | ajcc_pathologic_stage == "Stage IVB" ~ "Stage IV"
  )) |>
  select(-ajcc_pathologic_stage) |>
  tibble()
```

```{r}
mRNA_metadata |> 
  tibble() |>
  rename(TCGA_ID = "sample") |>
  select(TCGA_ID, Stage) |> 
  right_join(mRNA_log_long, by = 'TCGA_ID') |>
  ggplot(aes(x = Stage,
         y = log_reads,
         col = Status)) +
  geom_boxplot() +
  scale_color_manual(values = c("cancer" = "#f47c6c", 
                                "normal" = "#13b3ba")) + 
  labs(title = "Boxplot comparison of total miRNA expression between four cancer stages", color = "Tissue Type",
       x = "Cancer stage",
       y = "Log2 expression")
```

## General expression comparison between cancer and normal tissues

-   From the graph below, it can be seen that, in general, mRNAs expression is higher in cancer tissues.

```{r}
mRNA_log_long |>
  mutate(tissue_type = str_sub(TCGA_ID, 14, 14)) |>
  mutate(
    Status = case_when(tissue_type == 0 ~ "cancer",
                     (tissue_type == 1 | tissue_type == 2) ~ "normal",
                     .default = "other")) |>
  select(-tissue_type) |>
  filter(genes %in% top_genes) |>
  ggplot(aes(x = genes,
             y = log_reads,
             col = Status)) +
  geom_point() +
  labs(title = "Comparison of expression of 25 top differentially expressed mRNAs \nbetween cancer and normal TCGA samples", color = "Tissue Type",
       x = "mRNA IDs",
       y = "Log2 expression") +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1),
    plot.title = element_text(
      size = 12, 
      angle = 0))
```

## Volcano plot

-   In the following volcano plot, statistically significant values are highlighted in blue (the p-value is flipped, so it becomes more significant with the higher values). Positive LFC indicates higher expression in the cancer group compared to the normal tissues, that is in accordance with the plot above.

```{r}
# stating the significance based on the adjusted pvalues (FDR corrects for multiple comparisons)
top_genes_stat <- top_genes_stat |>
    mutate(
      significance = case_when(
        FDR > 0.05 ~ "no",
        FDR <= 0.05 ~ "yes"
      )
    )
```

```{r}
# defining the over-/underexpression character of genes
top_genes_stat <- top_genes_stat |>
  mutate(
    regulation = case_when(
      logFC > 1 ~ "Upregulated",
      logFC < -1 ~ "Downregulated",
      TRUE ~ "Non-significant"
    )
  )
```

```{r}
top_genes_stat |> 
  ggplot(aes(x = logFC,
             y = -log10(FDR),
             col = regulation)) +
  geom_point() +
  scale_color_manual(values = c("Upregulated" = "red", 
                                "Downregulated" = "blue", 
                                "Non-significant" = "gray"),
                     name = "Type of genes regulation") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  labs(x = "Log Fold Change",
       y = "-log10(FDR)",
       title = "Top Differentially Expressed mRNAs in TCGA-COAD Samples") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_text_repel(data = head(top_genes_stat_subset, 15),
    aes(x = logFC, y = -log10(FDR), label = genes),
    color = "black")
```

## Clean environment

```{r}
rm(list = ls())
```
