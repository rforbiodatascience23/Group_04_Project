---
title: "miRNA_analysis"
format: html
editor: visual
---

## Set Working directory

```{r setup}
own_path <- "/Users/kseniakirdey/Desktop/DTU/R_for_bio_data_science/lab_10_Project"
knitr::opts_knit$set(root.dir = paste0(own_path, "/group_04_project/data/"))
```

## Load Libraries

```{r}
library(tidyverse)
library(ggrepel)
```

## Fetch dataset

```{r}
miRNA_log_long <- readRDS(paste0(own_path, "/group_04_project/data/miRNA_aug.RDS"))
top_genes_stat <- readRDS(paste0(own_path, "/group_04_project/data/miRNA_top_genes_stat.RDS"))
```

Subsetting top 25 "log Fold Changed" genes for a better visualisation:

```{r}
top_genes_stat_subset <- top_genes_stat |>
  arrange(desc(abs(logFC))) |>
  head(n = 25)

top_genes <- top_genes_stat_subset$miRNA_ID
```

Uniting Stages in one group to facet the plots based on them later on.

```{r}
# unique(miRNA_log_long_full$ajcc_pathologic_stage)
# miRNA_log_long <- miRNA_log_long |>
#  mutate(Stage = case_when(
#     ajcc_pathologic_stage == "Stage I" | ajcc_pathologic_stage == "Stage IA" ~ "Stage I",
#     ajcc_pathologic_stage == "Stage II" | ajcc_pathologic_stage == "Stage IIA" |
#     ajcc_pathologic_stage == "Stage IIB" ~ "Stage II",
#     ajcc_pathologic_stage == "Stage III" | ajcc_pathologic_stage == "Stage IIIA" |
#     ajcc_pathologic_stage == "Stage IIIB" | ajcc_pathologic_stage == "Stage IIIC" ~ "Stage III",
#     ajcc_pathologic_stage == "Stage IV" | ajcc_pathologic_stage == "Stage IVB" ~ "Stage IV"
#   )) |>
#   select(-ajcc_pathologic_stage)
```

## First graph

-   Ideally, the samples should be taken from cancer and normal tissues of the same patients to get a proper overview of the expression difference. In our case, not all the samples had this comparison. Therefore, to make the conclusions based on the plots more precise, one should properly collect the expression data.

-   From the graph below, it can be seen that, in general, miRNAs expression is higher in cancer tissues.

```{r}
miRNA_log_long |>
  filter(miRNA_ID %in% top_genes) |>
  ggplot(aes(x = miRNA_ID,
             y = log_reads,
             col = Status)) +
  geom_point() +
  labs(title = "Comparison of expression of 25 top differentially expressed miRNAs \nbetween cancer and normal TCGA samples", color = "Tissue Type",
       x = "miRNA IDs",
       y = "Log2 expression") +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1),
    plot.title = element_text(
      size = 12, 
      angle = 0))
```

## Volcano plot

-   In the following volcano plot, statistically significant values are highlighted in blue (the p-value is flipped, so it becomes more significant with the higher values). Positive LFC indicates higher expression in the cancer group compared to the normal tissues, that is in accordance with the plots above.

```{r}
# stating the significance based on the adjusted pvalues (FDR corrects for multiple comparisons)
top_genes_stat <- top_genes_stat |>
    mutate(
      significance = case_when(
        FDR > 0.05 ~ "no",
        FDR <= 0.05 ~ "yes"
      )
    )
```

```{r}
top_genes_stat |> 
  ggplot(aes(x = logFC,
             y = -log10(PValue),
             col = significance)) +
  geom_point(alpha = 0.4) +
  theme_minimal() +
  labs(x = "Log Fold Change",
       y = "-log10(p-value)",
       title = "Top Differentially Expressed miRNAs in TCGA-COAD Samples") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  geom_text_repel(data = top_genes_stat_subset,
                  aes(label = miRNA_ID),
                      color = "black")
```

## Clean environment

```{r}
rm(miRNA_log_long_full)
rm(top_genes_stat)
rm(top_genes_stat_subset)
rm(top_genes)
```
